<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cluster Debug View</title>
    <link id="theme-stylesheet" rel="stylesheet" href="{{ url_for('static', filename='theme_glass.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>

<body>
    <header>
        <h1>Cluster Debug View</h1>
        <div class="status-bar">
            View: <a href="{{ url_for('overview_page') }}">Overview</a> |
            <a href="{{ url_for('detailed_page') }}">Detailed</a> |
            <a href="{{ url_for('docker_page') }}">Docker</a> |
            <a href="#" class="active-view">Debug</a>
            <span style="margin-left: 20px;">Last Updated: <span id="lastUpdated">Never</span></span>
            <span style="margin-left: 10px;">
                Theme: <select id="themeSelect" style="padding: 2px;">
                    <option value="glass">Glass (Dark)</option>
                    <option value="classic">Classic (Light)</option>
                </select>
            </span>
            {% if remote_user %}
            <span style="margin-left: 20px;">
                User: <strong>{{ remote_user }}</strong>
            </span>
            {% endif %}
        </div>
    </header>

    <main id="debugMain" class="overview-container"
        style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">

        <!-- Left: Users List -->
        <div class="host-card" style="flex: 1; min-width: 300px; max-width: 600px;">
            <h2>System Users</h2>
            <div id="usersListContainer" style="padding: 20px;">
                <p>Loading users...</p>
            </div>
            <button id="refreshUsersBtn" style="margin-top: 20px; padding: 5px 10px;">Refresh Users</button>
        </div>

        <!-- Right: Notification Test -->
        <div class="host-card" style="flex: 1; min-width: 300px; max-width: 400px; padding: 20px;">
            <h2>Notification System Test</h2>
            <p style="margin-bottom: 15px; color: var(--text-secondary);">Ensure generic permissions are granted.</p>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <label style="font-size: 0.9em;">Target User <small>(Leave empty for broadcast)</small></label>
                <input type="text" id="notif-user" placeholder="e.g. root"
                    style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: rgba(0,0,0,0.3); color: white;">

                <label style="font-size: 0.9em;">Title</label>
                <input type="text" id="notif-title" placeholder="Warning" value="Test Alert"
                    style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: rgba(0,0,0,0.3); color: white;">

                <label style="font-size: 0.9em;">Message Body</label>
                <textarea id="notif-body" rows="3"
                    style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: rgba(0,0,0,0.3); color: white; resize: vertical;">This is a test notification.</textarea>

                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="sendNotifBtn"
                        style="flex: 1; padding: 10px; cursor: pointer; background: var(--primary-color, #007bff); color: white; border: none; border-radius: 4px;">Send
                        Notification</button>
                    <button id="reqPermBtn"
                        onclick="if(window.notificationService) window.notificationService.requestPermission()"
                        style="flex: 1; padding: 10px; cursor: pointer;">Request Permission</button>
                </div>
            </div>
        </div>

        <!-- Hidden container to satisfy DashboardApp requirements -->
        <div id="dashboardContainer" style="display:none;"></div>
    </main>

    <footer>
        <p>Monitoring Dashboard - Debug Mode</p>
    </footer>

    <script id="initial-hosts-config" type="application/json">
        {{ initial_hosts_config | tojson | safe }}
    </script>
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        const initialConfigEl = document.getElementById('initial-hosts-config');
        let initialHostsConfig = [];
        if (initialConfigEl && initialConfigEl.textContent.trim()) {
            try {
                initialHostsConfig = JSON.parse(initialConfigEl.textContent);
            } catch (err) {
                console.error('Failed to parse initial host configuration JSON.', err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard(initialHostsConfig, 'debug');

            // --- User List Logic ---
            const container = document.getElementById('usersListContainer');
            const refreshBtn = document.getElementById('refreshUsersBtn');
            const lastUpdated = document.getElementById('lastUpdated');

            async function fetchUsers() {
                if (!container) return; // Guard
                container.innerHTML = '<p>Loading users...</p>';
                try {
                    const res = await fetch('/api/users');
                    const data = await res.json();

                    if (data.users && data.users.length) {
                        const ul = document.createElement('ul');
                        ul.style.display = 'grid';
                        ul.style.gridTemplateColumns = 'repeat(auto-fill, minmax(250px, 1fr))';
                        ul.style.gap = '10px';
                        ul.style.listStyle = 'none';
                        ul.style.padding = '0';

                        data.users.forEach(user => {
                            const li = document.createElement('li');
                            li.className = 'debug-user-tag';

                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = user.username;
                            nameSpan.style.fontWeight = 'bold';

                            const infoSpan = document.createElement('span');
                            infoSpan.className = 'uid-gid';
                            infoSpan.textContent = `UID: ${user.uid} | GID: ${user.gid}`;

                            li.appendChild(nameSpan);
                            li.appendChild(infoSpan);
                            ul.appendChild(li);
                        });
                        container.innerHTML = '';
                        container.appendChild(ul);
                        if (lastUpdated) lastUpdated.textContent = new Date().toLocaleTimeString();
                    } else {
                        container.innerHTML = '<p>No users found (or filtered) or error fetching.</p>';
                    }
                } catch (e) {
                    console.error(e);
                    container.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
                }
            }

            if (refreshBtn) refreshBtn.addEventListener('click', fetchUsers);
            fetchUsers();

            // --- Notification Test Logic ---
            const sendBtn = document.getElementById('sendNotifBtn');

            async function sendTestNotification() {
                const user = document.getElementById('notif-user').value;
                const title = document.getElementById('notif-title').value;
                const body = document.getElementById('notif-body').value;

                try {
                    const res = await fetch('/api/debug/notify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user, title, body, level: 'info' })
                    });
                    const data = await res.json();
                    console.log("Notification sent:", data);
                    alert("Sent: " + data.message);
                } catch (e) {
                    console.error("Failed to send notification:", e);
                    alert("Error: " + e.message);
                }
            }

            if (sendBtn) {
                sendBtn.addEventListener('click', sendTestNotification);
            }
        });
    </script>
</body>

</html>